# A Developer's Guide to the `gas-fakes` CLI

## Introduction

The `gas-fakes` library is a powerful tool for safely executing Google Apps Script in a local Node.js environment, functioning as a sandboxed runtime. This is particularly beneficial when running Google Apps Script generated by AI, as it mitigates the security risks associated with the broad permissions that scripts often require. `gas-fakes` enhances security by emulating the Apps Script environment through the translation of GAS service calls into their equivalent, underlying Google API requests, which allows for more granular and file-specific permission controls.

Until now, `gas-fakes` has primarily been used as a library within Node.js scripts. Recognizing the potential for broader application and improved developer experience, a command-line interface (CLI) tool has been created. This CLI tool for `gas-fakes` simplifies its use and is motivated by the idea that it will enhance its application, especially for tasks like conversational automation of Google Workspace when integrated with tools like the Gemini CLI.

## Getting Started

### 1. Installation

To install the `gas-fakes` CLI tool, run the following command in your terminal:

```bash
npm install -g @mcpher/gas-fakes
```

### 2. Authentication

After installation, you will need to authorize the tool to access your Google account. Detailed instructions for setting up authentication can be found in the official documentation: [Getting Started - Step 2: Set up authentication](https://github.com/brucemcpherson/gas-fakes/blob/main/GETTING_STARTED.md#step-2-set-up-authentication-shells-and-environment).

## Basic Usage

### Displaying Help

To see the available commands and options, run `gas-fakes` with no arguments:

```bash
gas-fakes --help
```

This will display the following help message:

```
$ gas-fakes --help
Usage: gas-fakes [options]

Execute Google Apps Script using gas-fakes.

Options:
  -v, --version             display the current version
  -f, --filename <string>   filename of the file including Google Apps Script. When this is used, the option --script is ignored.
  -s, --script <string>     provide Google Apps Script as a string. When this is used, the option --filename is ignored.
  -x, --sandbox             run Google Apps Script in a sandbox.
  -w, --whitelist <string>  whitelist of file IDs. Set the file IDs in comma-separated list. In this case, the files of the file IDs are used for both read and write. When this is used, the script is run in a sandbox.
  -j, --json <string>       JSON string including parameters for managing a sandbox. Enclose it with ' or ". When this is used, the option --whitelist is ignored. When this is used, the script is run in a sandbox.
  -d, --display             display the created script for executing with gas-fakes. Default is false. (default: false)
  -h, --help                display help for command
```

### Running a Script from a File

You can execute a script from a local file using the `-f` or `--filename` option.

**Example:**

1.  Create a file named `sample1.js` with the following content:

    ```javascript
    const rootFolder = DriveApp.getRootFolder();
    const rootFolderName = rootFolder.getName();
    console.log(rootFolderName);
    ```

2.  Run the following command:

    ```bash
    gas-fakes -f sample1.js
    ```

### Running a Script as a String

For shorter scripts, you can pass the code directly as a string using the `-s` or `--script` option.

**Example:**

```bash
gas-fakes -s "const rootFolder = DriveApp.getRootFolder(); const rootFolderName = rootFolder.getName(); console.log(rootFolderName)"
```

This will produce the same output as the file-based example.

## Sandbox Security

A key feature of `gas-fakes` is its ability to run scripts in a sandbox, which is a restricted environment that prevents the script from accessing unauthorized resources. This is especially important for running code from untrusted sources.

### Enabling the Sandbox

To enable the sandbox, use the `-x` or `--sandbox` option.

**Example:**

```bash
gas-fakes -x -f sample1.js
```

When you run this command, you will see a more verbose output that details the sandbox setup process:

```text
$ gas-fakes -x -f sample1.js
[Worker] ...importing Drive API
[Worker] ...importing Sheets API
[Worker] ...importing Slides API
[Worker] ...didnt find gasfakes.json ... skipping
[Worker] ...didnt find appsscript.json ... skipping
[Worker] ...didnt find .clasp.json ... skipping
[Worker] ...cache will be in /tmp/gas-fakes/cache
[Worker] ...properties will be in /tmp/gas-fakes/properties
[Worker] ...writing to gasfakes.json
[Worker] ...initializing auth and discovering project ID
[Worker] ...discovered and set projectId to for-testing
[Worker] Creating new Drive API client
MyDrive
...trashed 0 sandboxed files
...terminating worker thread
```

### Whitelisting Files in the Sandbox

By default, a sandboxed script cannot access any of your files. To grant access to specific files, you can use the `-w` or `--whitelist` option, providing a comma-separated list of file IDs.

**Example:**

1.  Create a file named `sample2.js` with the following content. Replace `###` with a file ID from your Google Drive.

    ```javascript
    const fileId = "###";
    const file = DriveApp.getFileById(fileId);
    const name = file.getName();
    console.log(name);
    ```

2.  If you run this in a sandbox without whitelisting, you will get an error:

    ```bash
    gas-fakes -x -f sample2.js
    ```

    **Output:**

    ```text
    Error: Access to file ### is denied by sandbox rules
    ```

3.  To grant access, add the file ID to the whitelist:

    ```bash
    gas-fakes -x -f sample2.js -w "###"
    ```

    This time, the script will execute successfully and print the name of the file.

### Advanced Sandbox Control

For more fine-grained control over the sandbox, you can use the `-j` or `--json` option to provide a JSON object that specifies permissions.

**Example:**

Using the same `sample2.js` file, you can define specific permissions for items and services:

```bash
gas-fakes -x -f sample2.js -j '{"whitelistItems":[{"itemId":"###"}],"whitelistServices":[{"className":"DriveApp","methodNames":["getFileById"]}]}'
```

In this example, the sandbox only allows access to the specified file ID (`itemId`) and only permits the use of the `getFileById` method from the `DriveApp` service.

#### JSON Schema for Sandbox Configuration

The JSON object used with the `-j` option follows this schema:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Whitelist and Blacklist Configuration",
  "description": "A configuration for whitelisting and blacklisting items and services.",
  "type": "object",
  "properties": {
    "whitelistItems": {
      "description": "A list of items to be whitelisted.",
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "itemId": {
            "description": "The file ID and folder ID of the file on Google Drive.",
            "type": "string"
          },
          "read": {
            "description": "Read permission for the item. Default is true.",
            "type": "boolean"
          },
          "write": {
            "description": "Write permission for the item. Default is false.",
            "type": "boolean"
          },
          "trash": {
            "description": "Trash permission for the item. Default is false.",
            "type": "boolean"
          }
        },
        "required": ["itemId"]
      }
    },
    "whitelistServices": {
      "description": "A list of services to be whitelisted.",
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "className": {
            "description": "The name of the class of the service.",
            "type": "string"
          },
          "methodNames": {
            "description": "A list of method names for the class to be whitelisted.",
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "required": ["className"]
      }
    },
    "blacklistServices": {
      "description": "A list of services to be blacklisted.",
      "type": "array",
      "items": {
        "type": "string"
      }
    }
  },
  "required": ["whitelistItems"]
}
```
## <img src="./logo.png" alt="gas-fakes logo" width="50" align="top">  Further Reading

- [getting started](GETTING_STARTED.md) - how to handle authentication for restricted scopes.
- [readme](README.md)
- [initial idea and thoughts](https://ramblings.mcpher.com/a-proof-of-concept-implementation-of-apps-script-environment-on-node/)
- [Inside the volatile world of a Google Document](https://ramblings.mcpher.com/inside-the-volatile-world-of-a-google-document/)
- [Apps Script Services on Node – using apps script libraries](https://ramblings.mcpher.com/apps-script-services-on-node-using-apps-script-libraries/)
- [Apps Script environment on Node – more services](https://ramblings.mcpher.com/apps-script-environment-on-node-more-services/)
- [Turning async into synch on Node using workers](https://ramblings.mcpher.com/turning-async-into-synch-on-node-using-workers/)
- [All about Apps Script Enums and how to fake them](https://ramblings.mcpher.com/all-about-apps-script-enums-and-how-to-fake-them/)
- [Russian version](README.RU.md) ([credit Alex Ivanov](https://github.com/oshliaer)) - needs updating
- [colaborators](collaborators.md) - additional information for collaborators
- [oddities](oddities.md) - a collection of oddities uncovered during this project
- [gemini](gemini.md) - some reflections and experiences on using gemini to help code large projects
- [named colors](named-colors.md)
- [sandbox](sandbox.md)
- [named range identity](named-range-identity.md)
- [adc and restricted scopes](https://ramblings.mcpher.com/how-to-allow-access-to-sensitive-scopes-with-application-default-credentials/)
- [push test pull](pull-test-push.md)
- [gas fakes cli](gas-fakes-cli.md)