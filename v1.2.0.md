# <img src="./logo.png" alt="gas-fakes logo" width="50" align="top"> New Features: Cloud Logging and Upstash Integration

This document details two major new features in `gas-fakes`: direct integration with Google Cloud Logging and the ability to use Upstash Redis as a shared backend for `PropertiesService` and `CacheService`.

---

## Cloud Logging Integration

`gas-fakes` now fully emulates the native Google Apps Script `Logger.log()` integration with Google Cloud Logging. This allows you to send structured logs from your local Node.js development environment directly to your Google Cloud project, providing a unified logging experience for both local and live scripts.

### Configuration

Logging behavior is controlled by the `LOG_DESTINATION` environment variable in your `.env` file. You can set this value by running the interactive `setup.sh` script or by editing the file manually.

| `LOG_DESTINATION`   | Behavior                                                                                             |
| ------------------- | ---------------------------------------------------------------------------------------------------- |
| `CONSOLE` (Default) | Logs structured JSON to the local console (`stdout`).                                                  |
| `CLOUD`             | Sends logs directly to Google Cloud Logging. Nothing is written to the local console.                |
| `BOTH`              | Sends logs to both Google Cloud Logging and the local console.                                       |
| `NONE`              | Disables all output from `Logger.log()`.                                                             |

When logging to the cloud, entries are sent to the `gas-fakes/console_logs` log name and include the following labels for easy filtering in the Cloud Logging Log Explorer:
- `gas-fakes-scriptId`
- `gas-fakes-userId`

### Dynamic Control and Usage

You can also change the logging destination at any time during runtime by setting the `Logger.__logDestination` property.

**Example:**

```javascript
// Set in .env: LOG_DESTINATION="CLOUD"

// This log goes only to Google Cloud Logging
Logger.log('Initial log entry to the cloud.');

// Switch to logging to both destinations
Logger.__logDestination = 'BOTH';
Logger.log({ message: 'This entry goes to cloud and console', severity: 'WARNING' });

// You can get a direct link to the logs for the current session
console.log('Cloud Log Link for this session:', Logger.__cloudLogLink);
```

---

## Upstash Integration for Shared Data Stores

You can now configure `gas-fakes` to use Upstash Redis as a backend for `PropertiesService` and `CacheService`. This powerful feature allows you to share data between your local Node.js environment and a live Apps Script project, enabling true cross-environment integration testing.

### 1. Configure `gas-fakes` (Local Environment)

First, set up your local environment to connect to Upstash.

*   **Get Upstash Credentials**: Sign up for a free Upstash Redis database and get your REST URL and Token.
*   **Update `.env`**: Run the `shells/setup.sh` script and set the `STORE_TYPE` to `UPSTASH`. Then, provide the URL and Token when prompted.

    Your `.env` file should look like this:
    ```env
    STORE_TYPE="UPSTASH"
    UPSTASH_REDIS_REST_URL="https://your-instance.upstash.io"
    UPSTASH_REDIS_REST_TOKEN="your-upstash-token"
    ```
*   **Match Script ID**: For data to be shared correctly, ensure the `scriptId` in your `gasfakes.json` file matches the Script ID of your live Apps Script project. If you use `.clasp.json`, this will be handled automatically.

### 2. Configure the Live Apps Script Project

Next, configure your live Apps Script project to access the same Upstash database using the `gas-flex-cache` library.

*   **Add the Library**: Add the `bmGasFlexCache` library to your `appsscript.json` manifest.

    ```json
    "dependencies": {
      "libraries": [{
        "userSymbol": "bmGasFlexCache",
        "libraryId": "1R_r9n4EGctvA8lWBZVeuT66mgaKBRV5IxfIsD_And-ra2H16iNXVWva0",
        "version": "9"
      }]
    }
    ```

*   **Store Credentials in Live Script**: Securely store your Upstash credentials in the live script's native `PropertiesService`. **Run this function once** from the Apps Script editor.

    ```javascript
    function setLiveCredentials() {
      const creds = {
        type: "upstash",
        url: "YOUR_UPSTASH_URL",
        token: "YOUR_UPSTASH_TOKEN"
      };
      PropertiesService.getScriptProperties()
        .setProperty("dropin_upstash_credentials", JSON.stringify(creds));
    }
    ```

*   **Instantiate the Drop-in Service**: In your live script, you can now create a "drop-in" replacement for `PropertiesService` or `CacheService` that connects to your shared Upstash database.

    ```javascript
    // Example: Reading a user property set by a gas-fakes test
    function readFromSharedStore() {
      const creds = JSON.parse(PropertiesService.getScriptProperties().getProperty("dropin_upstash_credentials"));
      
      // Add context for user-specific data
      creds.userId = Session.getEffectiveUser().getEmail();
      creds.scriptId = ScriptApp.getScriptId();
      creds.kind = 'property'; // or 'cache'

      // Create a service instance that talks to Upstash
      const sharedUserProps = bmGasFlexCache.newCacheDropin({ creds });
      
      // Read a value that was written by a local gas-fakes script
      const valueFromFake = sharedUserProps.getProperty('cross-props-user');
      console.log(valueFromFake); // Should log "value-for-user"
    }
    ```

With this setup, you can write seamless integration tests that validate behavior across both your local and live environments.

